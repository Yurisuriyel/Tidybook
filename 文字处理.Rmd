---
title: "文字处理"
author: "Linze Yu"
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: TRUE
    default_style: "light"
    downcute_theme: "default"
    fig_width: 7
    fig_height: 5
    use_bookdown: TRUE
    gallery: TRUE
    lightbox: TRUE
    highlight: tango
editor_options: 
  markdown: 
    wrap: 72
---

```{r, 代码全局设置, echo = F}
knitr::opts_chunk$set(warning = F, error = F, message = F, prompt = F, comment = "", echo = T, dpi = 200, collapse = F, fig.align = "left", dev = "png", cache = T)
# , eval = F代码显示不运行
# , include = F代码运行, 不显示代码和结果
# , echo = T 显示代码块
# , prompt = T使用>开始代码
# , comment = ""结果不使用##
# , collapse = T#代码合并结果
# , out.width/out.height = 0.8缩放
# , fig.align = "left","center","right"对齐方式
# , dev = "pdf","png","svg","jpeg"记录设备
# , cache = T
```

# 加载包
```{r 加载包}
library("YuriR") #
```

# 批量文字处理
## 导入文本
```{r}
setwd("D:/desktop/book/tidybook/data/文字处理")
Files <- list.files()[c(1:6)]
Files
文本 <- list()
for (i in 1:length(Files)) {
  文本[[i]] <- readLines(Files[i], encoding = "utf-8") %>% as.character()
}
class(文本[[1]])
```

## 设置分词器
```{r}
set.seed(2022)
分词器 <- list()
for (i in 1:length(文本)) {
  分词器[[i]] <- worker(
    type = "mix", # 模型mp,hmm,mix,query,tag,keywords,simhash
    dict = DICTPATH, # 系统词典
    hmm = HMMPATH,
    user = USERPATH, # 用户词典
    user_weight = "max", # min,median
    idf = IDFPATH,
    stop_word = "D:/desktop/book/Text Mining/stop.txt",
    write = T,
    qmax = 20,
    topn = 5,
    encoding = "UTF-8",
    detect = T,
    symbol = F,
    # lines = 1e+05, # 读取行数,大文件,实现分次读取
    output = NULL,
    bylines = F
  )
}
```

## 分词
```{r}
data <- list()
for (i in 1:length(文本)) {
  segment(文本[[i]], 分词器[[i]]) -> data[[i]]
}
```

## 除去数字
```{r}
data1 <- list()
for (i in 1:length(data)) {
  data1[[i]] <- data[[i]][!grepl("[0-9]", data[[i]])]
}
```

## 除去单字
```{r}
data2 <- list()
for (i in 1:length(data1)) {
  data2[[i]] <- data1[[i]][nchar(data1[[i]]) >= 2]
}
```

## 提取
```{r}
top <- list()
for (i in 1:length(data2)) {
  top[[i]] <- sort(table(data2[[i]]), decreasing = T) # [1:100]
}
```

```{r}
top1 <- list()
for (i in 1:length(top)) {
  top[[i]] %>%
    mutate_vars(N, scale) %>%
    slice_dt(1:20) -> top1[[i]]
}
top1[[1]]
```

## 合并数据
```{r}
bind <- list()
for (i in 1:length(top1)) {
  top1[[i]] %>%
    data.table() %>%
    mutate_dt(year = 0 + i) -> bind[[i]]
}
bind[[1]] %>%
  rbind(bind[[2]]) %>%
  rbind(bind[[3]]) %>%
  rbind(bind[[4]]) %>%
  rbind(bind[[5]]) %>%
  rbind(bind[[6]]) -> end
```

```{r, fig.width = 7, fig.height = 7}
end %>%
  ggplot(aes(x = reorder(V1, N), y = N, color = V1, fill = V1)) +
  geom_col(color = NA, alpha = 1) +
  scale_y_continuous(breaks = seq(0, 200, by = 25), minor_breaks = seq(0, 200, by = 12.5)) +
  # scale_fill_gradientn(colors = viridis::viridis(500)) +
  # scale_color_gradientn(colors = viridis::viridis(500)) +
  scale_color_manual(values = viridis::viridis(101)) +
  scale_fill_manual(values = viridis::viridis(101)) +
  # scale_color_manual(values = cols) +
  # scale_fill_manual(values = fills) +
  facet_wrap(~year, ncol = 3, scales = "free") +
  coord_flip() +
  Yuri_theme +
  theme(
    legend.position = "none",
    axis.line = element_line(size = 0.5),
    axis.ticks.x = element_line(size = 0.5),
    axis.ticks.y = element_line(size = 0.5),
    axis.ticks.length = unit(0.1, "cm"),
    panel.grid.major.x = element_line(color = "#96999C", size = 0.5, linetype = 3, lineend = "round"),
    panel.grid.minor.x = element_line(color = "#96999C", size = 0.25, linetype = 3, lineend = "round"),
  ) +
  labs(x = "", y = "", title = "词频")
```
